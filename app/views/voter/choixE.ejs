<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CFDT Votant</title>
	<link rel="shortcut icon" href="./../../images/logo.gif" type="image/x-icon">
	<link rel="icon" href="./../../images/logo.gif" type="image/x-icon">
	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<link rel="stylesheet" type="text/css" href="./../../css/voter/custom.css">
</head>
<body>
	<div class="container text-center">
    	<p style="text-align: right;"><a href="/logout">Déconnexion</a></p>
    	<header>
    		<div class="container-fluid inner-header">
    			<div class="row row-inner-header">
	    			<div class="col-xs-4 col-inner-header">
	    			    <a href="#"><img id="uir-logo" src="./../../images/uir.png" alt="UIR logo"></a>
	    			</div>

	    			<div class="col-xs-4 col-inner-header">
		    			<h1>XVIIème CONGRES
		    				<br/>
		    				UIR-CFDT</h1>    				
	    			</div>

	    			<div class="col-xs-4 col-inner-header">
		    			<a href="#"><img id="cfdt-logo" src="./../../images/logo.gif" alt="CFDT logo"></a>    			    				
	    			</div>
    			</div>
    		</div>
    	</header>
    	<section>
		    <div class="row title">
		    	<div class="col-xs-9 titre">
			        <h4> 
			        	<%= vote.intitule.toUpperCase() %>
			    	</h4>
					<p>Sélectionnez vos 24 conseillers</p>
		    	</div>
		    	<div class="col-xs-3 fond-blanc">
		        	<h4>MANDATS</h4>
		    		<input type="number" class="text-center nbMandat" min="0" value="<%= user.nbMandat %>" readonly />
		    	</div>
		    </div>
	    		<div class="fond-blanc">
	    			<form action="/confirmationE/vote/<%= vote._id %>" method="post">
					    <div class="row ">
					        <div class="col-xs-12 proposition">
					        	<div class="row">
					        		<div class="col-xs-12 col-md-6 reponse">
					        			<table class="table table-striped table-responsive tab-selection">
					        				<tr>
					        					<th>LISTE DES CONSEILLERS</th>
					        				</tr>
					        				<tr>
					        					<td>Défilez la liste et cliquez pour ajouter dans votre sélection</td>
					        				</tr>
					        			</table>
					        			<div class="list-election">
						        			<table class="table table-striped table-responsive tab-list">
						        				<% for (let i = 0; i < vote.choix.length; i++){ %>
													<tr>
														<td class="rang select">
															<%= i+1 %>
														</td>
														<td class="choice-to-select">
															<input class="input-list" value="<%= vote.choix[i].nom %>" readonly />
														</td>
													</tr>
						        				<% } %>
											</table>
										</div>
					        		</div>
					        		<div class="col-xs-12 col-md-6 reponse">
					        			<table class="table table-striped table-responsive">
					        				<tr>
					        					<th>VOTRE SÉLECTION</th>
					        				</tr>
					        				<tr>
					        					<td>Cliquez pour retirer le représentant</td>
					        				</tr>
					        			</table>
					        			<div class="list-choices">
						        			<table class="table table-striped table-responsive tab-choices">
											</table>
										</div>
					        		</div>
					        	</div>
					        </div>
						</div>
					    <div class="row">
					     	<div class="col-lg-12">
				         		<button type="submit" class="valider-choix-unable" disabled>
						         	<h4>Valider</h4>
								</button>
					     	</div>
					    </div>
					</form>
	    		</div>		    		
       	</section>
    </div>

	<footer class="text-center">
		<p>DW2 Simplon Réunion | 2017</p>
	</footer>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
	<!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>-->
	<script type="text/javascript">

		let candidat = document.querySelectorAll(".choice-to-select");
		let tabchoices = document.querySelector(".tab-choices");
		let inputList = document.querySelectorAll(".input-list");
		let toSubmit = document.querySelector(".valider-choix-unable");

		function addRow(){
			// AJOUTER UN CHOIX
			// Change le CSS
			$(this.parentNode).removeClass('choice-to-select').addClass('choice-unable');
			$(this).prop('disabled', true);

			// Ajout la ROW
			let tr = document.createElement("tr");
			$(tr).addClass("tr-choice");
			tabchoices.append(tr);

			// Ajout des colonnes (rang + input)
			let tdRang = document.createElement("td");
			let tdChoiceSelected = document.createElement("td");

			// Ajout RANG
			tr.append(tdRang);
			$(tdRang).addClass("rang-selection");
			let nbTdRang = document.querySelectorAll(".rang-selection");
			tdRang.innerText = nbTdRang.length;

			tr.append(tdChoiceSelected);
			$(tdChoiceSelected).addClass("choice-selected");

			// Ajout INPUT
			// let rangSelection = document.createElement("input");
			// tdRang.append(rangSelection);

			// $(rangSelection).attr("value");
			// $(rangSelection).prop("readonly", true);

			// tdRang.append(rangSelection);

			// Ajout INPUT
			let input = document.createElement("input");
			$(input).addClass("input-choice");
			$(input).attr("name");
			input.name = "choix";
			$(input).prop("readonly", true);

			tdChoiceSelected.append(input);
			input.value = this.value;

			let inputChoice = document.querySelectorAll(".input-choice");

			valideOrNot(inputChoice, 24, toSubmit, 0);


			// Une fois créer il est possible d'enlever de la liste

			// DOM sur les input et le ligne TR à supprimer
			// let selection = document.querySelectorAll(".input-choice");
			let trToDelete = document.querySelectorAll('.tr-choice');

			let unable = document.querySelectorAll(".input-list");
			console.log("Tab unable : " + unable)

			// SUPPRIMER UN CHOIX
			// A chaque clique on supprime le TR du Tableau
			for(let j = 0; j < inputChoice.length; j++){
				inputChoice[j].addEventListener("click", (e) => {

					// Comparer avec le liste de gauche pour changer le CSS 
					unable.forEach( (element) => {
						if(inputChoice[j].value == element.value){
							let tdParent =  element.parentNode;
							$(tdParent).removeClass('choice-unable').addClass('choice-to-select');
							$(element).prop('disabled', false);
						}
					});
					
					// Supprimer la ligne
					$(trToDelete[j]).remove();
					valideOrNot(inputChoice, 24, toSubmit, 1);
		
				});				
			}

		};

		function valideOrNot (tab, lengthMax, button, num){
			console.log("longueur du tableau ", tab.length);
			if((tab.length-num) === lengthMax){
				$(button).prop('disabled', false);
				$(button).removeClass('valider-choix-unable').addClass('valider-choix');
			} else {
				$(button).prop('disabled', true);
				$(button).removeClass('valider-choix').addClass('valider-choix-unable');
			}
		}

		toSubmit.addEventListener("click", function(){
			let inputChoice = document.querySelectorAll(".input-choice");
			if(inputChoice.length < 24){
				alert("Vous avez sélectionné moins de 24 noms");
				// $(toSubmit).prop('disabled', false);
			} else if (inputChoice.length > 24){
				// $(toSubmit).prop('disabled', true);
				alert("Vous avez sélectionné plus de 24 noms");
			}
		});

		for(let i = 0; i < inputList.length; i++){
			inputList[i].addEventListener("click", addRow);
		}
				
	</script>
</body>
</html>